- name: Make SSL directory
  file: path="{{ bespin_settings.web.ssl_dir }}" state=directory

- name: Place SSL private key
  copy: src="../../../files/{{ bespin_settings.web.ssl_cert_file }}" dest="{{ bespin_settings.web.ssl_dir }}/cacert.pem"
        mode=400

- name: Place SSL Certificate
  copy: src="../../../files/{{ bespin_settings.web.ssl_key_file }}" dest="{{ bespin_settings.web.ssl_dir }}/privkey.pem"
        mode=400

- name: Remove existing ui directory
  file:
    state: absent
    path: "{{ bespin_settings.ui.srv_dir }}"

- name: Make empty ui directory
  file:
    state: directory
    path: "{{ bespin_settings.ui.srv_dir }}"

- name: Download bespin-ui release tar.gz
  unarchive:
    src: "{{ bespin_settings.ui.dist_base_url }}/{{ bespin_settings.ui.dist_version }}/{{ bespin_settings.ui.dist_filename }}"
    dest: "{{ bespin_settings.ui.srv_dir }}"
    remote_src: yes

- name: Create app container
  docker_container:
    image: dukegcb/bespin-web
    name: bespin-web
    env: "{{ web_environment }}"
    volumes:
      - /etc/external/:/etc/external/
      - "{{ bespin_settings.ui.srv_dir }}:/srv/ui/"
    ports:
      - "80:80"
      - "443:443"
    pull: true
    etc_hosts: "{{ bespin_hosts_list }}"
    state: started
    restart_policy: always
