- name: "Fetch details about bespin-deploy service account"
  command: kubectl get serviceaccount bespin-deploy -o json
  register: bespin_deploy_info

- set_fact:
    service_account_details: "{{ bespin_deploy_info['stdout'] }}"

- name: Fetch details about bespin-deploy service account secret
  command: >
    kubectl get secret
    "{{ service_account_details['secrets'][0]['name'] }}"
    -o json
  register: bespin_deploy_secret_info

- set_fact:
    service_account_secret_details: "{{ bespin_deploy_secret_info['stdout'] }}"

- set_fact:
    gcloud_k8s_token: "{{ service_account_secret_details['data']['token'] | b64decode }}"

- name: Fetch details about cluster so we can determine the hostname
  command: kubectl get endpoints kubernetes --output=jsonpath={.subsets[0].addresses[0].ip}
  register: kubectl_endpoints_info

- set_fact:
    gcloud_k8s_host: "https://{{ kubectl_endpoints_info['stdout'] }}"
