- name: Ensure directory exists for cloning git repo
  file:
    state: directory
    path: "{{ local_repo_root }}/{{ image_name }}-{{ version }}"

# Note that this checks out the git repo to a specific local directory based on the
# provided image_name and version. it does not infer a subdirectory name from the
# remote git repo like the default git mode. We must use a unique name here so that
# one host can support distinct image builds
- name: Clone the Git repo at the provided version
  git:
    repo: "{{ repo_url }}"
    dest: "{{ local_repo_root }}/{{ image_name }}-{{ version }}"
    version: "{{ version }}"

- name: Build a docker image
  docker_image:
    path: "{{ local_repo_root }}/{{ image_name }}-{{ version }}"
    name: "{{ image_name }}"
    tag: "{{ version }}"

- name: Build secondary image (if configured)
  docker_image:
    path: "{{ local_repo_root }}/{{ image_name }}-{{ version }}/{{ secondary_context }}"
    name: "{{ secondary_image_name }}"
    tag: "{{ secondary_version }}"
    buildargs: "{{ secondary_buildargs }}"
  when: secondary_context is defined and secondary_version is defined and secondary_buildargs is defined
